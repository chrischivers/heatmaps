<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        <meta charset="utf-8">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
        <title>Heatmaps</title>
        <style>
          #map {
              height: 90%;
          }

          html, body {
              height: 100%;
              margin: 0;
              padding: 0;
          }
        </style>
    </head>
    <body>

        <div class="dropdown">
            <div class="btn-group">
                <div class="btn-group">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButtonCity" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                London
                    </button>
                    <div class="dropdown-menu" id="city-dropdown-menu" aria-labelledby="dropdownMenuButtonCity"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButtonPlaceType" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Restaurants
                    </button>
                    <div class="dropdown-menu" id="place-type-dropdown-menu" aria-labelledby="dropdownMenuButtonPlaceType"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButtonPlaceSubType" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i>All</i>
                    </button>
                    <div class="dropdown-menu" id="place-sub-type-dropdown-menu" aria-labelledby="dropdownMenuButtonPlaceSubType"></div>
                </div>
            </div>
        </div>
        <div id="map"></div>
        <script>

          var map;
          var heatmap;
          var placeType = "RESTAURANT";
          var placeSubType = "All";
          var city = "London";
          var placeGroupData;


          function initMap() {
              map = new google.maps.Map(document.getElementById('map'), {
                  center: {lat: 51.505485, lng: -0.127889},
                  zoom: 14
              });

              getCities();
              getPlaceGroupData();

              google.maps.event.addListener(map, 'idle', function () {
                  alert(map.getZoom());
                  plotHeatMap(map.getBounds(), placeType, placeSubType, map.getZoom());
              });

          }

          function plotHeatMap(mapBounds, placeType, placeSubType, zoom) {

              var boundsParams = "bounds=" + mapBounds.toString();
              var placeTypeParams = "placeType=" + placeType;
              var placeSubTypeParams = "placeSubType=" + placeSubType;
              var zoomParams = "zoom=" + zoom.toString();
              var xmlhttp = new XMLHttpRequest();
              xmlhttp.onreadystatechange = function () {
                  if (this.readyState === 4 && this.status === 200) {
                      placeArray = JSON.parse(this.responseText);
                      if (heatmap) {
                          heatmap.setMap(null);
                      }
                      if (placeArray.length !== 0) {
                          var heatmapData = getLatLngPoints(placeArray);
                          heatmap = new google.maps.visualization.HeatmapLayer({
                              data: heatmapData
                          });
                          heatmap.setMap(map);
                      }
                  }
              };
              xmlhttp.open("GET", "/heatpoints?" + boundsParams + "&" + placeTypeParams + "&" + placeSubTypeParams + "&" + zoomParams, true);
              xmlhttp.send();

              function getLatLngPoints(placeArray) {
                  var latLngArray = [];
                  for (var i in placeArray) {
                      var lat = placeArray[i].lat;
                      var lng = placeArray[i].lng;
                      latLngArray.push(new google.maps.LatLng(lat, lng));
                  }
                  return latLngArray;
              }
          }

          function setCityDefaultView(cityName) {
              var xmlhttp = new XMLHttpRequest();
              xmlhttp.onreadystatechange = function () {
                  if (this.readyState === 4 && this.status === 200) {
                      var defaultViewJson = JSON.parse(this.responseText);
                      map.setCenter(new google.maps.LatLng(defaultViewJson.lat, defaultViewJson.lng));
                      map.setZoom(defaultViewJson.zoom);

                  }
              };
              xmlhttp.open("GET", "/defaultView?city=" + cityName, true);
              xmlhttp.send();
          }

          function getCities() {
              var xmlhttp = new XMLHttpRequest();
              xmlhttp.onreadystatechange = function () {
                  if (this.readyState === 4 && this.status === 200) {
                      var citiesArray = JSON.parse(this.responseText);
                      var cityDropdown = $("#city-dropdown-menu");
                      for (var i in citiesArray) {
                          var c = citiesArray[i];
                          var a = document.createElement('a');
                          a.className = "dropdown-item";
                          a.id = c;
                          a.text = c;
                          a.addEventListener("click", function () {
                              city = this.id;
                              setCityDefaultView(this.id);
                              $(this).closest(".btn-group").find('.btn').text(this.id);
                          });
                          cityDropdown.append(a);
                      }
                  }
              };
              xmlhttp.open("GET", "/cities", true);
              xmlhttp.send();
          }

          function setPlaceMenusStartingState() {

              setPlaceTypesMenu();
              setSubTypesMenuForParent(placeType);
          }

          function setPlaceTypesMenu() {
              var placeTypesDropdown = $("#place-type-dropdown-menu");
              for (var i in placeGroupData) {
                  var dropDownTypeItem = createPlaceTypeDropDownElement(placeGroupData[i].placeType.name);
                  placeTypesDropdown.append(dropDownTypeItem);
              }
          }

          function setSubTypesMenuForParent(parentId) {

              var subTypeDropdown = $("#place-sub-type-dropdown-menu");
              subTypeDropdown.children().remove();
              subTypeDropdown.append(createSubTypeDropDownElement("All", parentId));

              for (var j in placeGroupData) {
                  if (placeGroupData[j].placeType.name === parentId) {
                      for (var k in placeGroupData[j].subTypes) {
                          var subType = placeGroupData[j].subTypes[k].name;
                          var dropDownItem = createSubTypeDropDownElement(subType, parentId);
                          subTypeDropdown.append(dropDownItem);
                      }
                  }
              }
              subTypeDropdown.closest(".btn-group").find('.btn').text("All");
          }

          function createPlaceTypeDropDownElement(placeTypeName) {
              var a = document.createElement('a');
              a.className = "dropdown-item";
              a.id = placeTypeName;
              a.text = toTitleCase(placeTypeName) + "s";
              a.addEventListener("click", function () {
                  placeType = this.id;
                  plotHeatMap(map.getBounds(), this.id, "All", map.getZoom());
                  $(this).closest(".btn-group").find('.btn').text(toTitleCase(this.id) + "s");

                  setSubTypesMenuForParent(this.id);
              });
              return a;
          }

          function createSubTypeDropDownElement(subTypeName, parentName) {
              var b = document.createElement('a');
              b.className = "dropdown-item";
              b.parentPlaceType = parentName;
              b.id = subTypeName;
              b.text = toTitleCase(subTypeName);
              b.addEventListener("click", function () {
                  placeSubType = this.id;
                  plotHeatMap(map.getBounds(), this.parentPlaceType, this.id, map.getZoom());
                  $(this).closest(".btn-group").find('.btn').text(toTitleCase(this.id));
              });
              return b;
          }

          function getPlaceGroupData() {
              var xmlhttp = new XMLHttpRequest();
              xmlhttp.onreadystatechange = function () {
                  if (this.readyState === 4 && this.status === 200) {
                      placeGroupData = JSON.parse(this.responseText);
                      setPlaceMenusStartingState();
                  }
              };
              xmlhttp.open("GET", "/placegroups", true);
              xmlhttp.send();
          }


          function toTitleCase(str) {
              return str.replace(/\w\S*/g, function (txt) {
                  return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
              });
          }

        </script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAsL6wsuPFovAUq8STgMIp0xrOqMjv3F6A&libraries=visualization&callback=initMap">
        </script>
        <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    </body>
</html>